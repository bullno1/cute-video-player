#!/bin/sh

BUILD_TYPE=${BUILD_TYPE:-RelWithDebInfo}

BUILD_DIR="${BUILD_TYPE}"

mkdir -p .build
cd .build

if [ "$(uname)" = "FreeBSD" ] && [ -z "$CI" ]
then
	export PATH=/usr/local/llvm20/bin:$PATH
	export CC=$(which clang)
	export CXX=$(which clang++)
fi

if [ ! -f "${BUILD_DIR}/build.ninja" ]
then
	cmake \
		-G "Ninja" \
		-B ${BUILD_DIR} \
		-DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
		-DCMAKE_TOOLCHAIN_FILE=../../cmake/linux.cmake \
		-DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
		-DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
		-DCMAKE_C_COMPILER_LAUNCHER=ccache \
		-DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
		../
fi

cmake --build ${BUILD_DIR}
